<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!-- $Id$ -->

<project basedir="../../.." default="build" name="ptII" 
	 xmlns:artifact="antlib:org.apache.maven.artifact.ant"
	 >
  <path id="fmi.classpath">
    <pathelement location="${basedir}"/>
    <pathelement location="${basedir}/lib/jna.jar"/>
    <pathelement location="${basedir}/lib/junit-4.8.2.jar"/>
  </path>
  <property name="debuglevel" value="source,lines,vars" />

  <!-- The fmu property names the .fmu file to be opened. 
       To choose different fmu files, run 'ant fmu_cs -Dfmu=file.fmu'"
   -->
  <property name="fmu" value="org/ptolemy/fmi/fmu/cs/bouncingBall.fmu" />

  <!-- fmi.reports contains reports generated by checkstyle, findbugs and test.
       fmi.reports must be declared before any properties that refer to it. (Lame).
    -->
  <property name="fmi.reports" value="${basedir}/reports" />

  <!-- junit.formatter defaults to plain and is used by checkstyle and test.  Other values: brief, failure, plain -->
  <property name="junit.formatter" value="plain" />

  <!-- The output director for junit. -->
  <property name="junit.output.dir" value="${fmi.reports}/junit" />

  <!-- The tests that are run by the test target. -->
  <property name="test.batch" value="org/ptolemy/fmi/driver/test/junit/*.java" />

  <!-- Ant patternsets. Alphabetize, please -->
  <patternset id="fmi.excludes">
    <exclude name="**/adm/"/>
  </patternset>

  <target name="build"
	  description="Compile the java files."
	  >
    <echo message="${ant.project.name}: ${ant.file}" />
    <javac debug="true"
	   debuglevel="${debuglevel}"
	   includeAntRuntime="false">
      <src path="${basedir}/org/ptolemy/fmi" />
      <patternset refid="fmi.excludes" />
      <classpath refid="fmi.classpath" />
    </javac>
  </target>

  <target name="clean"
	  description="Remove all the class files in org/ptolemy/fmi.">
    <delete quiet="true">
      <fileset dir="org/ptolemy/fmi"
	       includes="*.class" />
      <fileset dir="org/ptolemy/fmi/driver"
	       includes="*.class" />
      <fileset dir="org/ptolemy/fmi/driver/test/junit"
	       includes="*.class" />
    </delete>
  </target>

  <target name="fmu_cs" depends="build"
	  description="Run a co-simulation.  To use a specific .fmu file, run ant fmu_cs -Dfmu=org/ptolemy/fmi/fmu/cs/bouncingBall.fmu"
	  >
    <java classname="org.ptolemy.fmi.driver.FMUCoSimulation"
	  fork="true">
      <classpath>
	<path refid="fmi.classpath"/>
      </classpath>
      <arg line="${fmu}"/>
    </java>
  </target>


  <target name="initReports">
    <mkdir dir="${junit.output.dir}" />
  </target>


  <target name="run" depends="fmu_cs"/>

  <target name="test" depends="build, initReports"
	  description="Run the junit tests in junit/*.java.">
    <echo>
      To run different tests, use -Dtest.batch, for example:
      ant test -Dtest.batch=org/ptolemy/fmi/driver/test/junit/*.java
      To change format Use -Djunit.formatter=xml|brief|plain|failure, default is plain.
      Output is in ${junit.output.dir}.

      test.batch = ${test.batch}

    </echo>
    <junit fork="no"
	   printsummary="on"
	   showoutput="true">
      <classpath>
	<path refid="fmi.classpath" />
      </classpath>
      <batchtest todir="${junit.output.dir}">
	<fileset defaultexcludes="yes"
		 dir="${basedir}">
	  <include name="${test.batch}" />
	</fileset>
      </batchtest>
      <formatter type="${junit.formatter}" />
    </junit>
    <echo message="See ${junit.output.dir} for test results." />
  </target>


</project>
